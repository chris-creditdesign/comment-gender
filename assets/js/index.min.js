var allBars=["#1abc9c","#27ae60","#3498db","#5959b7","#34495e"];!function(){var a=function(a){function b(){var b=".checkbox",c=b+" input[type='checkbox']",d=b+" input[type='radio']",e="checked";a(b).each(function(){a(this).removeClass(e)}),a(c+":checked").each(function(){a(this).parent(b).addClass(e)}),a(d+":checked").each(function(){a(this).parent(b).addClass(e)})}function c(a,b){return a.country<b.country?-1:a.country>b.country?1:0}var d=a("#constrain-content"),e=a("#nav");setTimeout(function(){d&&e?(d.addClass("single-column"),e.remove()):setTimeout(arguments.callee,100)},100),a(".outer-wrapper").css({display:"block"}),a(".status-message").css({display:"none"});var f={top:30,right:20,bottom:15,left:75},g=630-f.left-f.right,h=350-f.top-f.bottom,i=450,j=[],k=[],l=[],m="TotalPaper",n="Total papers published",o="Papers published",p=[],q=[],r=["All"],s=[],t=!0,u=d3.select(".count-chart").append("svg").attr("width",g+f.left+f.right).attr("height",h+f.top+f.bottom),v=u.append("g").attr("transform","translate("+f.left+",0)"),w=u.append("g").attr("transform","translate("+f.left+",0)"),x=u.append("g").attr("class","x axis").attr("transform","translate("+f.left+",0)"),y=d3.format(",");a.ajax({url:"data/citation-data.html",dataType:"text",success:function(d){function e(){for(;p.length>0;)p.shift();for(;l.length>0;)l.shift();for(;k.length>0;)k.shift();for(;k.length>0;)k.shift();for(var a=0;a<j.length;a++)l.push({});for(var c=0;c<l.length;c++)l[c].country=j[c].country,l[c].countryCode=j[c].countryCode,l[c].continent=j[c].continent;switch(m){case"TotalPaper":for(var d=0;d<l.length;d++)l[d].choice=j[d].TotalPaper,l[d].choiceFemale=0;break;case"Single":for(var e=0;e<l.length;e++)l[e].choice=j[e].SingleM,l[e].choiceFemale=j[e].SingleF;break;case"NatFirst":for(var f=0;f<l.length;f++)l[f].choice=j[f].NatFirstM,l[f].choiceFemale=j[f].NatFirstF;break;case"NatLast":for(var g=0;g<l.length;g++)l[g].choice=j[g].NatLastM,l[g].choiceFemale=j[g].NatLastF;break;case"IntFirst":for(var h=0;h<l.length;h++)l[h].choice=j[h].IntFirstM,l[h].choiceFemale=j[h].IntFirstF;break;case"IntLast":for(var i=0;i<l.length;i++)l[i].choice=j[i].IntLastM,l[i].choiceFemale=j[i].IntLastF;break;case"FMRatio":for(var n=0;n<l.length;n++)l[n].choice=j[n].FMRatio,l[n].choiceFemale=0;break;default:for(var o=0;o<l.length;o++)l[o].choice=j[o].TotalPaper,l[o].choiceFemale=0}for(var q=0;q<l.length;q++){var r=l[q].country;d3.select(".country-select [value="+r+"]").property("checked")&&p.push(l[q])}console.table(p),A(),D(),b()}function z(){var b=a(this).val();if("All"===b)a(".continent-select input").prop("checked",a(this).prop("checked")),a(".country-select input").prop("checked",a(this).prop("checked"));else for(var c=0;c<a(".country-select input").length;c++){var d=a(".country-select input").eq(c);b===d.data("continent")&&d.prop("checked",a(this).prop("checked"))}e()}function A(){I.domain([0,d3.max(p,function(a){return a.choice})]),p.length>5?K.domain(d3.range(p.length)):K.domain(d3.range(5));var a=v.selectAll("rect").data(p,function(a){return a.country}),b=w.selectAll("rect").data(p,function(a){return a.country});s.push(a[0].length),t=s.slice(-2)[1]>=s.slice(-2)[0]?!0:!1,s.shift(),a.enter().append("rect").attr("x",function(a,b){return K(b)}).attr("width",function(){return"TotalPaper"==m||"FMRatio"==m?K.rangeBand():K.rangeBand()/2}).attr("y",h+f.top).attr("height",0).attr("opacity",.6).attr("fill",function(a){switch(a.continent){case"Australasia":return allBars[0];case"North_America":return allBars[1];case"Asia":return allBars[2];case"Europe":return allBars[3];case"South_America":return allBars[4];default:return allBars[0]}}),b.enter().append("rect").attr("x",function(a,b){return K(b)+K.rangeBand()/2}).attr("width",K.rangeBand()/2).attr("y",h+f.top).attr("height",0).attr("opacity",1).attr("fill",function(a){switch(a.continent){case"Australasia":return allBars[0];case"North_America":return allBars[1];case"Asia":return allBars[2];case"Europe":return allBars[3];case"South_America":return allBars[4];default:return allBars[0]}}),a.transition().duration(i).delay(function(){return t?0:i}).attr("x",function(a,b){return K(b)}).attr("width",function(){return"TotalPaper"==m||"FMRatio"==m?K.rangeBand():K.rangeBand()/2}).attr("y",function(a){return f.top+I(a.choice)}).attr("height",function(a){return h-I(a.choice)}),b.transition().duration(i).delay(function(){return t?0:i}).attr("x",function(a,b){return K(b)+K.rangeBand()/2}).attr("width",K.rangeBand()/2).attr("y",function(a){return f.top+I(a.choiceFemale)}).attr("height",function(a){return h-I(a.choiceFemale)}),a.exit().transition().duration(i).attr("x",function(){return d3.select(this).attr("x")}).attr("width",function(){return d3.select(this).attr("width")}).attr("y",h+f.top).attr("height",0).remove(),b.exit().transition().duration(i).attr("x",function(){return d3.select(this).attr("x")}).attr("width",function(){return d3.select(this).attr("width")}).attr("y",h+f.top).attr("height",0).remove();var c=x.selectAll("text").data(p,function(a){return a.country});c.enter().append("text").attr("x",function(a,b){return K(b)+K.rangeBand()/2}).attr("y",function(){return h+f.top}).attr("text-anchor","middle").text(function(a){return a.countryCode}),c.transition().duration(i).delay(function(){return t?0:i}).attr("x",function(a,b){return K(b)+K.rangeBand()/2}).attr("y",function(a){return a.choiceFemale>=a.choice?f.top+I(a.choiceFemale)-4:f.top+I(a.choice)-4}),c.exit().transition().duration(i).attr("x",function(){return d3.select(this).attr("x")}).attr("y",h+f.top).remove(),u.select(".outer-wrapper .y").transition().duration(i).call(J),a.on("mouseover",function(a){var b=a.country,c=a.choice,d=a.choiceFemale,e=d3.select(this).attr("x"),f=d3.select(this).attr("y");d3.select(this).attr("fill","#f1c40f"),B(b,c,d,e,f)}).on("mouseout",function(){d3.select(this).attr("fill",function(a){switch(a.continent){case"Australasia":return allBars[0];case"North_America":return allBars[1];case"Asia":return allBars[2];case"Europe":return allBars[3];case"South_America":return allBars[4];default:return allBars[0]}}),C()}),b.on("mouseover",function(b,c){var d=b.country,e=b.choice,f=b.choiceFemale,g=d3.select(a[0][c]).attr("x"),h=d3.select(a[0][c]).attr("y");d3.select(this).attr("fill","#f1c40f"),B(d,e,f,g,h)}).on("mouseout",function(){d3.select(this).attr("fill",function(a){switch(a.continent){case"Australasia":return allBars[0];case"North_America":return allBars[1];case"Asia":return allBars[2];case"Europe":return allBars[3];case"South_America":return allBars[4];default:return allBars[0]}}),C()}),c.on("mouseover",function(b,c){var d=b.country,e=b.choice,f=b.choiceFemale,g=d3.select(a[0][c]).attr("x"),h=d3.select(a[0][c]).attr("y");d3.select(a[0][c]).attr("fill","#f1c40f"),B(d,e,f,g,h)}).on("mouseout",function(b,c){d3.select(a[0][c]).attr("fill",function(a){switch(a.continent){case"Australasia":return allBars[0];case"North_America":return allBars[1];case"Asia":return allBars[2];case"Europe":return allBars[3];case"South_America":return allBars[4];default:return allBars[0]}}),C()})}function B(b,c,d,e,f){var g,h="",j=b.replace(/_/g," ");g="TotalPaper"==m?y(c):c,h="TotalPaper"==m||"FMRatio"==m?j+"<br /> "+g:j+"<br />Male: "+c+"<br />Female: "+d,d3.select(".tooltip").select(".value").html(h);var k=parseInt(a(".tooltip").css("width"),10),l=parseInt(a(".tooltip").css("height"),10),n=parseInt(e,10)-k/2+65,o=parseInt(f,10)-l-43;d3.select(".tooltip").style("left",n+"px").style("top",o+"px"),d3.select(".tooltip").classed("hidden",!1).transition().duration(i/2).style("opacity",1)}function C(){d3.select(".tooltip").transition().duration(i/2).style("opacity",0).each("end",function(){d3.select(".tooltip").classed("hidden",!0)})}function D(a){switch(a){case"TotalPaper":n="Total papers published",o="Papers published";break;case"Single":n="Single",o="Citations";break;case"NatFirst":n="National first",o="Citations";break;case"NatLast":n="National last",o="Citations";break;case"IntFirst":n="International first",o="Citations";break;case"IntLast":n="International last",o="Citations";break;case"FMRatio":n="Female to male ratio",o="Female to male ratio"}d3.select(".outer-wrapper h1").text(n),d3.selectAll(".y .axisLabel text").text(o)}for(var E=a(d).find("tbody tr"),F=0;F<E.length;F++){var G={};G.country=E.eq(F).find("td").eq(0).text(),G.countryCode=E.eq(F).find("td").eq(1).text(),G.continent=E.eq(F).find("td").eq(2).text(),G.TotalPaper=parseInt(E.eq(F).find("td").eq(3).text(),10),G.SingleF=parseFloat(E.eq(F).find("td").eq(4).text()),G.SingleM=parseFloat(E.eq(F).find("td").eq(5).text()),G.NatFirstF=parseFloat(E.eq(F).find("td").eq(6).text()),G.NatFirstM=parseFloat(E.eq(F).find("td").eq(7).text()),G.NatLastF=parseFloat(E.eq(F).find("td").eq(8).text()),G.NatLastM=parseFloat(E.eq(F).find("td").eq(9).text()),G.IntFirstF=parseFloat(E.eq(F).find("td").eq(10).text()),G.IntFirstM=parseFloat(E.eq(F).find("td").eq(11).text()),G.IntLastF=parseFloat(E.eq(F).find("td").eq(12).text()),G.IntLastM=parseFloat(E.eq(F).find("td").eq(13).text()),G.FMRatio=parseFloat(E.eq(F).find("td").eq(14).text()),j.push(G)}var H=j.length;s.push(H),q=j.map(function(a){return a.continent}),a.each(q,function(b,c){-1===a.inArray(c,r)&&r.push(c)}),d3.selectAll(".continent-select").selectAll("label").data(r.sort()).enter().append("label").attr("class","checkbox").html(function(a){var b=a.replace(/_/g," ");return"<span class='icon'>	<svg height='20' width='20'><circle cx='10' cy='10' r='10' class='dots "+a+"'></circle><polygon fill='#ECF0F1' points='8.163,11.837 6.062,9.737 3.963,11.837 6.062,13.938 8.163,16.037 16.037,8.162 13.938,6.062'/></polygon></svg></span><input type='checkbox' value='"+a+"' data-continent='"+a+"' checked>"+b}),d3.selectAll(".country-select").selectAll("label").data(j.sort(c)).enter().append("label").attr("class","checkbox").html(function(a){var b=a.country.replace(/_/g," ");return"<span class='icon'>	<svg height='20' width='20'><circle cx='10' cy='10' r='10' class='dots'></circle><polygon fill='#ECF0F1' points='8.163,11.837 6.062,9.737 3.963,11.837 6.062,13.938 8.163,16.037 16.037,8.162 13.938,6.062'/></polygon></svg></span><input type='checkbox' value='"+a.country+"' data-continent='"+a.continent+"' checked>"+b+" ("+a.countryCode+")"}),d3.selectAll(".field-select input").on("change",function(){m=this.value,e(),D(m)}),d3.selectAll(".country-select input").on("change",e),d3.selectAll(".continent-select input").on("change",z);var I=d3.scale.linear().range([h,0]),J=d3.svg.axis().scale(I).tickSize(3,3).orient("left");u.append("g").attr("class","y axis").attr("transform","translate("+f.left+","+f.top+")").append("g").attr("class","axisLabel").append("text").attr("transform","rotate(-90)").attr("y",-f.left).attr("x",-h).attr("dy",".9em").style("text-anchor","left");var K=d3.scale.ordinal().domain(d3.range(j.length)).rangeRoundBands([0,g+f.right],.4);e(),b()}})};setTimeout(function(){"undefined"!=typeof jQuery?a(jQuery):setTimeout(arguments.callee,60)},60)}();