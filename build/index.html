<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Polopoly</title>
	<script src="http://nature.com/view/scripts/jquery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<!-- <script src="https://poly-admin1.nature.com/polopoly_static/js/jquery-1.6.4.js" type="text/javascript"></script> -->

	<link rel="stylesheet" type="text/css" href="polopoly/reset.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/html5.css" />
	<link rel="stylesheet" type="text/css" href="polopoly/layout.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/header.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/footer.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/news-main.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/comments.css" />	
	<link rel="stylesheet" type="text/css" href="polopoly/mobile.css" />	



</head>


<!--[if lt IE 6]><body class="lt-ie6"><![endif]-->
<!--[if IE 6]><body class="ie6"><![endif]-->
<!--[if IE 7]><body class="ie7"><![endif]-->
<!--[if IE 8]><body class="ie8"><![endif]-->
<!--[if gt IE 8]><body class="gt-ie8"><![endif]-->
<!--[if !IE]>--><body><!--<![endif]-->

<div id="constrain">

<div id="main">
	<div id="constrain-content" class="cleared">
		<div id="content" class="col">
			<article>
				<div id="article">
					<section>
						<div class="section">
							<div class="html-widget img-rigth">

<!-- ========= PASTED POLOPOLY HEADER ABOVE ========= -->







<style scoped>
.status-message{border:1px solid #c00;background:#fac7c7;padding:10px}.outer-wrapper{width:630px;height:1000px;display:none}.outer-wrapper h1{font-size:1.1em;letter-spacing:.1em;padding:0 0 0 3px;margin:0}.outer-wrapper .count-chart{position:relative;height:350px;width:630px}.outer-wrapper .count-chart .tooltip{position:absolute;padding:10px;background-color:#333;pointer-events:none;opacity:0;z-index:100;max-height:40px}.outer-wrapper .count-chart .tooltip p{margin:0;color:#ecf0f1;font-family:sans-serif;font-size:16px;line-height:20px}.outer-wrapper .count-chart .tooltip:before{content:"";position:absolute;bottom:-10px;left:49%;border-right:0;border-top:10px solid #333;border-bottom:0;border-left:10px solid transparent}.outer-wrapper .count-chart .tooltip.hidden{display:none}.outer-wrapper .count-chart .axis line,.outer-wrapper .count-chart .axis path{fill:none;stroke:#666;shape-rendering:crispEdges}.outer-wrapper .count-chart .axis text{font-family:sans-serif;fill:#666;font-size:13px;shape-rendering:crispEdges}.outer-wrapper .count-chart .x.axis text{font-size:12px;cursor:default}.outer-wrapper .count-chart rect{shape-rendering:crispEdges}.outer-wrapper .wrapper h2{text-transform:uppercase;font-size:1.1em;letter-spacing:.1em;text-align:center;color:#666;padding:10px 0 5px;margin:0 0 5px}.outer-wrapper .wrapper p{font-size:1.1em;line-height:1.4em;padding:10px 0 0;text-align:center;font-weight:400;color:#666}.outer-wrapper .country-wrapper,.outer-wrapper .wrapper{width:630px;padding:0 0 0 10px;float:left;clear:left}.outer-wrapper form.continent-select,.outer-wrapper form.country-select,.outer-wrapper form.field-select{float:left}.outer-wrapper form.continent-select label,.outer-wrapper form.country-select label,.outer-wrapper form.field-select label{float:left;width:115px;margin:0 10px 0 0;display:block;cursor:pointer}.outer-wrapper form.field-select label{width:170px}.outer-wrapper form.continent-select label.checkbox,.outer-wrapper form.country-select label.checkbox,.outer-wrapper form.field-select label{margin-bottom:6px;padding-left:30px;position:relative;-webkit-transition:.25s;-moz-transition:.25s;-o-transition:.25s;transition:.25s;-webkit-backface-visibility:hidden}.outer-wrapper form.field-select label:hover,.outer-wrapper label.checkbox:hover{color:#a0bec5}.outer-wrapper form.field-select input[type=radio],.outer-wrapper label.checkbox input[type=checkbox]{outline:0!important;opacity:0;filter:alpha(opacity=0);zoom:1;float:left;margin-left:-40px}.outer-wrapper form.field-select label span,.outer-wrapper label.checkbox .icon{display:block;height:20px;left:0;opacity:1;position:absolute;top:-3px;width:20px;-webkit-transition:opacity .1s linear;-moz-transition:opacity .1s linear;-o-transition:opacity .1s linear;transition:opacity .1s linear;-webkit-backface-visibility:hidden}.outer-wrapper label.checkbox.checked .icon .dots{fill:#a0bec5}.outer-wrapper label.checkbox.checked .icon .dots.Australasia{fill:#1abc9c;opacity:.8}.outer-wrapper label.checkbox.checked .icon .dots.North_America{fill:#27ae60;opacity:.8}.outer-wrapper label.checkbox.checked .icon .dots.Asia{fill:#3498db;opacity:.8}.outer-wrapper label.checkbox.checked .icon .dots.Europe{fill:#5959b7;opacity:.8}.outer-wrapper label.checkbox.checked .icon .dots.South_America{fill:#34495e;opacity:.8}.outer-wrapper label.checkbox .icon .dots{fill:#ecf0f1}
</style>
<h1>Gender barchart for comment</h1>
<p>Introduction</p>

<p class="status-message"><em>The interactive companion to this table requires a modern browser (e.g. Chrome, Safari, Firefox or Internet Explorer 9+) with javascript enabled.</em></p>

<div class="outer-wrapper">
	
	<h1>Total papers published</h1>
	<div class="count-chart">
		<div class="tooltip hidden">
			<p><span class="value"></span></p>
		</div>
	</div><!-- count-chart -->

	<div class="wrapper field-wrapper">
	<h2>Field</h2>
		<form class="field-select">

			<label for="TotalPaper">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots TotalPaper'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="TotalPaper" value="TotalPaper" checked>
				Total Paper
			</label>
			<label for="SingleF">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots SingleF'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="SingleF" value="SingleF">
				Single Female
			</label>
			<label for="SingleM">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots SingleM'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="SingleM" value="SingleM">
				Single Male
			</label>
			<label for="NatFirstF">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots NatFirstF'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="NatFirstF" value="NatFirstF">
				National First Female
			</label>
			<label for="NatFirstM">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots NatFirstM'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="NatFirstM" value="NatFirstM">
				National First Male
			</label>
			<label for="NatLastF">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots NatLastF'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="NatLastF" value="NatLastF">
				National Last Female
			</label>
			<label for="NatLastM">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots NatLastM'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="NatLastM" value="NatLastM">
				National Last Male
			</label>
			<label for="IntFirstF">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots IntFirstF'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="IntFirstF" value="IntFirstF">
				International First Female
			</label>
			<label for="IntFirstM">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots IntFirstM'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="IntFirstM" value="IntFirstM">
				International First Male
			</label>
			<label for="IntLastF">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots IntLastF'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="IntLastF" value="IntLastF">
				International Last Female
			</label>
			<label for="IntLastM">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots IntLastM'>
					</svg>
				</span>	
				<input type="radio" name="mode" id="IntLastM" value="IntLastM">
				International Last Male
			</label>
			<label for="FMRatio">
				<span class='icon'>
					<svg height='20' width='20'>
						<circle cx='10' cy='10' r='10' class='dots FMRatio'>
					</svg>
				</span>
				<input type="radio" name="mode" id="FMRatio" value="FMRatio">
				Female to Male Ratio
			</label>
		</form>
	</div><!--class="field-wrapper"-->

	<div class="wrapper country-wrapper">
		<h2>Continent</h2>
		<form class="continent-select">
		</form>

		<h2>Country</h2>
		<form class="country-select">
		</form>
	</div><!--wrapper country-wrapper-->

</div> <!-- outer-wrapper -->
<!--[if gt IE 8]><!-->
<script src="http://www.nature.com/polopoly_static/js/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript">
/*	News Section Colours */
var colourPurple =	["#DABDD8","#95177E","#B570A7","#651E59","#461E47"];
var colourYellow =	["#FED162","#F8B436","#F29500","#D37510","#AF6A17"];
var colourRed =		["#EE8361","#EB6B4B","#E85338","#E53524","#A8131D"];
var colourBlue =	["#84D0F0","#3BAADC","#006DB2","#2C3387","#152760"];
var colourGreen =	["#E1DC00","#96BE17","#45A72C","#00892F","#00642D"];

/*	Typography */
var colourText =	["#363636","#707070","#006699","#5C7996","#222222","#EEEEEE","#F5821F","#C4C4C4"];

/*	Border Colours */
var colourBorder =	["#999999","#E7E7E7","#C7C8CC","#B7B7B7","#D4D4D4","#CCCCCC","#006699","#C4C4C4"];
  
/*	Background Colours */
var colourBackground =	["#006699","#2C2C2C","#E1E4E9","#ECECEC","#5E5E5E","#F9F9F9","#F0F1F3"];

/*	Colours for the bars */
var allBars = ["#1abc9c","#27ae60","#3498db","#5959b7","#34495e"];

/*	==================================================================================== */
/*	JQUERY READY */

(function() {
		var init = function($)
		{

		/*	==================================================================================== */
		/*	Remove nav column and add class single-column to constrain-content column
			so that it will be 956px wide. Bassed on Andrew code.
			CHECK BEFORE USE!!!!! */
		var content = $('#constrain-content');
		var nav = $('#nav');

		setTimeout(function () {
			if (content && nav) {
				content.addClass('single-column');
				nav.remove();
			} else {
				setTimeout(arguments.callee, 100);
			}
		}, 100);

		/*	==================================================================================== */
		/*	STATUS MESSAGE FOR NO-JS */
		/*	We know that javascript is enabled and that we are not in IE 6-8
			so hide the error message and show outer-wrapper */
		$(".outer-wrapper").css({"display":"block"});
		$(".status-message").css({"display":"none"});

		/*	==================================================================================== */
		/*	GLOBAL VARIABLES FOR D3 */

		/*	Margin, Width and height */
		var margin = {top: 30, right: 20, bottom: 15, left: 75};
		var width = 630  - margin.left - margin.right;
		var height = 350 - margin.top - margin.bottom;
		/*	Global variable to control the length of D3 transitons */
		var duration = 450;
		/*	Array to hold the data ajaxed form the table */
		var dataset = [];
		var sortArray = [];
		var yearArray = [];
		var checkArray = [];

		/*	Global variable to hold the cc or ac choice */
		var field = "TotalPaper";
		var headerString = "Total papers published";
		var axisString = "Papers published";

		/*	Global Array to hold all the data we currently want to display */
		var displayArray = [];

		/*	Arrays used to build the country and continent checkboxes */
		var continentArray = [];
		var uniqueContinentArray = ["All"];

		var totalBarArray = [];
		var addingBars = true;

		/* Create custom checkboxes */
		function setupLabel() {
			var checkBox = ".checkbox";
			var checkBoxInput = checkBox + " input[type='checkbox']";
			var checkBoxChecked = "checked";

			if ($(checkBoxInput).length) {
				$(checkBox).each(function(){
					$(this).removeClass(checkBoxChecked);
				});
				$(checkBoxInput + ":checked").each(function(){
					$(this).parent(checkBox).addClass(checkBoxChecked);
				});
			}
		}


		/*	Create SVG element */
		var svg = d3.select(".count-chart")
				.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom);

		/* Add a group for each row of bars */
		var blocks = svg.append("g")
						.attr("transform", "translate(" + margin.left + ",0)");

		/* Add a group for each row of text */
		var groups = svg.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(" + margin.left + ",0)");

		/*	Function to sort data.year200X by country name */
		function compareCountry(a,b) {
			if (a.country < b.country)
				return -1;
			if (a.country > b.country)
				return 1;
			return 0;
		}

		/* Add commas to numbers if needed */
		var thousandFormat = d3.format(',');

		/*	==================================================================================== */
		/*	AJAX CALL. LOAD IN JSON AND CALL DRAW */

		/*	We now want to load in the data from our html table */

		$.ajax({
			url: "data/citation-data.html",
				dataType: 'text',
				success: function (data) {
					/*	Store each row of the table in a var */
					var tableRows = $(data).find("tbody tr");

					for (var i = 0; i < tableRows.length; i++) {
						var newObject = {};

						newObject.country = tableRows.eq(i).find("td").eq(0).text();
						newObject.countryCode = tableRows.eq(i).find("td").eq(1).text();
						newObject.continent = tableRows.eq(i).find("td").eq(2).text();
						newObject.TotalPaper = parseInt(tableRows.eq(i).find("td").eq(3).text(), 10);
						newObject.SingleF = parseFloat(tableRows.eq(i).find("td").eq(4).text());
						newObject.SingleM = parseFloat(tableRows.eq(i).find("td").eq(5).text());
						newObject.NatFirstF = parseFloat(tableRows.eq(i).find("td").eq(6).text());
						newObject.NatFirstM = parseFloat(tableRows.eq(i).find("td").eq(7).text());
						newObject.NatLastF = parseFloat(tableRows.eq(i).find("td").eq(8).text());
						newObject.NatLastM = parseFloat(tableRows.eq(i).find("td").eq(9).text());
						newObject.IntFirstF = parseFloat(tableRows.eq(i).find("td").eq(10).text());
						newObject.IntFirstM = parseFloat(tableRows.eq(i).find("td").eq(11).text());
						newObject.IntLastF = parseFloat(tableRows.eq(i).find("td").eq(12).text());
						newObject.IntLastM = parseFloat(tableRows.eq(i).find("td").eq(13).text());
						newObject.FMRatio = parseFloat(tableRows.eq(i).find("td").eq(14).text());

						dataset.push(newObject);
					}

					/* store this number to use to create a staggered transition */
					var numberOfBars = dataset.length;

					totalBarArray.push(numberOfBars);

					/*	Create an array containing each continent and the use $.each and $.inArray
						to remove all duplicates. The result will be stored in uniqueContinentArray */
					continentArray = dataset.map(function(d) { return d.continent; });

					$.each(continentArray, function(i, el){
						if($.inArray(el, uniqueContinentArray) === -1) {
							uniqueContinentArray.push(el);
						}
					});

					/* Create checkboxes for each continent inside the continent-select form */
					d3.selectAll(".continent-select")
						.selectAll("label")
						.data(uniqueContinentArray.sort())
						.enter()
						.append("label")
						.attr("class", "checkbox")
						.html(function (d) {
							var continentString = d.replace(/_/g, ' ');
							return "<span class='icon'>	<svg height='20' width='20'><circle cx='10' cy='10' r='10' class='dots " + d +  "'></circle><polygon fill='#ECF0F1' points='8.163,11.837 6.062,9.737 3.963,11.837 6.062,13.938 8.163,16.037 16.037,8.162 13.938,6.062'/></svg></span><input type='checkbox' value='" + d + "' data-continent='" + d + "' checked>" + continentString;
						});

					/* Create checkboxes for each country inside the country-select form */
					d3.selectAll(".country-select")
						.selectAll("label")
						.data(dataset.sort(compareCountry)) // I'm sorting the dataset at this point - probably don't want to do that
						// .data(dataset) // I'm sorting the dataset at this point - probably don't want to do that
						.enter()
						.append("label")
						.attr("class", "checkbox")
						.html(function (d) {
							var countryString = d.country.replace(/_/g, ' ');
							return "<span class='icon'>	<svg height='20' width='20'><circle cx='10' cy='10' r='10' class='dots'></circle><polygon fill='#ECF0F1' points='8.163,11.837 6.062,9.737 3.963,11.837 6.062,13.938 8.163,16.037 16.037,8.162 13.938,6.062'/></svg></span><input type='checkbox' value='" + d.country + "' data-continent='" + d.continent + "' checked>" + countryString + " (" + d.countryCode + ")";
						});

					/*	When a field button is clicked update the field variable to represent the selected 
						field and call updateDisplayArray() */
					d3.selectAll(".field-select input").on("change", function(){
						field = this.value;
						updateDisplayArray();
						updateHeader(field);
					});

					/*	Call updateDisplayArray() when one of the country checkboxes is clicked */
					d3.selectAll(".country-select input").on("change", updateDisplayArray);

					/*	Call updateContinent() when one of the continent checkboxes is clicked */
					d3.selectAll(".continent-select input").on("change", updateContinent);

					/*	function called to copy the relevant year's data into the displayArray array
						then add a property called choice that holds the relevant count and field value */
					function updateDisplayArray() {

						/* First remove the existing data from the arrays */
						while (displayArray.length > 0) {
							displayArray.shift();
							}

						while (yearArray.length > 0) {
							yearArray.shift();
							}

						while (checkArray.length > 0) {
							checkArray.shift();
							}

						while (sortArray.length > 0) {
							sortArray.shift();
							}

						while (sortArray.length > 0) {
							sortArray.shift();
							}

						for (var i = 0; i < dataset.length; i++) {
								checkArray.push({});
						}

						for (var w = 0; w < checkArray.length; w++) {
							checkArray[w].country = dataset[w].country;
							checkArray[w].countryCode = dataset[w].countryCode;
							checkArray[w].continent = dataset[w].continent;
						}

						switch (field) {
							case "TotalPaper":
								for (var a = 0; a < checkArray.length; a++) {
									checkArray[a].choice = dataset[a].TotalPaper;
								}
								break;
							case "SingleF":
								for (var b = 0; b < checkArray.length; b++) {
									checkArray[b].choice = dataset[b].SingleF;
								}
								break;
							case "SingleM":
								for (var c = 0; c < checkArray.length; c++) {
									checkArray[c].choice = dataset[c].SingleM;
								}
								break;
							case "NatFirstF":
								for (var d = 0; d < checkArray.length; d++) {
									checkArray[d].choice = dataset[d].NatFirstF;
								}
								break;
							case "NatFirstM":
								for (var e = 0; e < checkArray.length; e++) {
									checkArray[e].choice = dataset[e].NatFirstM;
								}
							break;
							case "NatLastF":
								for (var f = 0; f < checkArray.length; f++) {
									checkArray[f].choice = dataset[f].NatLastF;
								}
							break;
							case "NatLastM":
								for (var g = 0; g < checkArray.length; g++) {
									checkArray[g].choice = dataset[g].NatLastM;
								}
							break;
							case "IntFirstF":
								for (var h = 0; h < checkArray.length; h++) {
									checkArray[h].choice = dataset[h].IntFirstF;
								}
							break;
							case "IntFirstM":
								for (var j = 0; j < checkArray.length; j++) {
									checkArray[j].choice = dataset[j].IntFirstM;
								}
							break;
							case "IntLastF":
								for (var k = 0; k < checkArray.length; k++) {
									checkArray[k].choice = dataset[k].IntLastF;
								}
							break;
							case "IntLastM":
								for (var l = 0; l < checkArray.length; l++) {
									checkArray[l].choice = dataset[l].IntLastM;
								}
							break;
							case "FMRatio":
								for (var m = 0; m < checkArray.length; m++) {
									checkArray[m].choice = dataset[m].FMRatio;
								}
							break;
							default:
								for (var n = 0; n < checkArray.length; n++) {
									checkArray[n].choice = dataset[n].cc;
								}
						}

						/*	Find out if each country is checked and if so copy their
							object from checkArray into displayArray */
						for (var p = 0; p < checkArray.length; p++) {
							var countryName = checkArray[p].country;

							if (d3.select(".country-select [value=" + countryName + "]").property("checked")) {
								displayArray.push(checkArray[p]);
							}
						}

						/*	Sort displayArray into the descending order 
							If the contries happen to have the same value for choice then they are sorted into alphabetical order */
						displayArray.sort(function(a, b) {
								if (b.choice < a.choice) {
									return -1;
								}
								else if (b.choice > a.choice) {
									return 1;
								} else if (b.choice === a.choice) {
									return a.country < b.country ? -1 : a.country > b.country ? 1 : 0;
								}
							});

						updateBars();
						updateHeader();
						setupLabel();
					}

					/*	Function called when a continent button is clicked to turn on and off groups of countries */
					function updateContinent() {
						var thisContinent = $(this).val();

						if ( thisContinent === "All" ) {
							$(".continent-select input").prop("checked", $(this).prop("checked"));
							$(".country-select input").prop("checked", $(this).prop("checked"));
						} else {
							/*	Loop through the countries, if the data attribute for continent matches the
								value of the continent check box then make its propenty "checked" match the 
								continent checkbox calling the function i.e. turn it on or off */
							for (var i = 0; i < $(".country-select input").length; i++) {
								var checkBoxes = $(".country-select input").eq(i);

								if (thisContinent === checkBoxes.data('continent') ) {
									checkBoxes.prop("checked", $(this).prop("checked"));
								}
								
							}
						}

						updateDisplayArray();
					}

					/*	Set up bars - one for each country in the chosen year */
					svg.selectAll("rect")
								.data(dataset, function(d, i) {
									return d.country;
								})
								.enter()
								.append("rect")
								.attr("width", 0)
								.attr("x", 0)
								.attr("height", 0)
								.attr("y", 0);

					/*	Define Y scale range to go from height to 0
						Do not define the domaine yet */
					var yScale = d3.scale.linear()
						.range([height , 0]);

					/*	Define Y axis */
					var yAxis = d3.svg.axis()
						.scale(yScale)
						.tickSize(3, 3)
						.orient("left");

					/*	Prepare the Y axis but do not call .call(yAxis) yet */
					svg.append("g")
						.attr("class", "y axis")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
					.append("g")
						.attr("class", "axisLabel")
						.append("text")
						.attr("transform", "rotate(-90)")
						.attr("y", -margin.left)
						.attr("x", -height)
						.attr("dy", ".9em")
						.style("text-anchor", "left");

					var xScale = d3.scale.ordinal()
						.domain(d3.range(dataset.length))
						.rangeRoundBands([0,(width + margin.right)], 0.1);

					function updateBars () {
						/*	Update the yScale domain the current highest value */
						yScale.domain([0, d3.max(displayArray, function(d) { return d.choice;} )]);

						/*	Make sure that the bars don't get too fat by keeping the xScale range above 5 */
						if (displayArray.length > 5) {
							xScale.domain(d3.range(displayArray.length));
						} else {
							xScale.domain(d3.range(5));
						}

						/*	Pass the new display array data to bars */
						/*	Do I need this? */
						var bars = blocks.selectAll("rect")
								.data(displayArray, function(d, i) {
									return d.country;
								});


						/*	Find out if bars are being taken away if so  addingBars = false; 
							in order to alter the delay of the exiting bars	*/
						totalBarArray.push(bars[0].length);

						if ( totalBarArray.slice(-2)[1] >= totalBarArray.slice(-2)[0] ) {
							addingBars = true;
						} else {
							addingBars = false;
						}

						totalBarArray.shift();

						/* Enter… */
						bars.enter()
							.append("rect")
							.attr("x", function(d, i){
								return xScale(i);
							})
							.attr("width", xScale.rangeBand())
							.attr("y", height + margin.top)
							.attr("height", 0 )
							.attr("opacity",0.8)
							.attr("fill", function(d, i){
								switch (d.continent) {
									case "Australasia" :
										return allBars[0];
									case "North_America" :
										return allBars[1];
									case "Asia" :
										return allBars[2];
									case "Europe" :
										return allBars[3];
									case "South_America" :
										return allBars[4];
									default:
										return allBars[0];
								}
							});

						/*	Update… */
						bars.transition()
							.duration(duration)
							.delay(function() {
								if (!addingBars) {
									return duration;
								} else {
									return 0;
								}
							})
							.attr("x", function(d, i){
								return xScale(i);
							})
							.attr("width", xScale.rangeBand())
							.attr("y", function(d){
								return margin.top + yScale(d.choice);
							})
							.attr("height", function(d){
								return height - yScale(d.choice);
							});

						/*	Exit… */
						bars.exit()
							.transition()
							.duration(duration)
							.attr("x", function(d, i){
								return d3.select(this).attr("x");
							})
							.attr("width", function(d, i){
								return d3.select(this).attr("width");
							})
							.attr("y", height + margin.top)
							.attr("height", 0 )
							.remove();

						/*	Repeat the bars Enter, Update and Exit for the text lables */
						var text = groups.selectAll("text")
								.data(displayArray, function(d, i) {
									return d.country;
								});

						/* Enter… */
						text.enter()
							.append("text")
							.attr("x", function(d, i){
								return xScale(i) + (xScale.rangeBand() / 2);
							})
							.attr("y", function(d){
								return height + margin.top;
							})
							.attr("text-anchor", "middle")
							.text(function(d) { return d.countryCode; });

						/*	Update… */
						text.transition()
							.duration(duration)
							.delay(function() {
								if (!addingBars) {
									return duration;
								} else {
									return 0;
								}
							})
							.attr("x", function(d, i){
								return xScale(i) + (xScale.rangeBand() / 2);
							})
							.attr("y", function(d){
								return margin.top + yScale(d.choice) - 2;
							});

						/*	Exit… */
						text.exit()
							.transition()
							.duration(duration)
							.attr("x", function(d, i){
								return d3.select(this).attr("x");
							})
							.attr("y", height + margin.top)
							.remove();

						/* Call the Y axis to adjust it to the new scale */
						svg.select(".outer-wrapper .y")
							.transition()
							.duration(duration)
							.call(yAxis);

						/*	Extract the info needed to build the tooltip
							and send it to the makeTooltip function */
						bars.on("mouseover", function(d) {
								
								var country = d.country;
								var choice = d.choice;

								var x = d3.select(this).attr("x");
								var y = d3.select(this).attr("y");

								/*	Hover colour applied with javascript rather than CSS
									so that it can be trigged by the text too */
								d3.select(this)
									.attr("fill","#f1c40f");

								makeTooltip(country,choice,x,y);
							})
							.on("mouseout", function(d,i) {
								/* Return the bar to it's continent colour */
								d3.select(this).attr("fill", function(d, i){
									switch (d.continent) {
										case "Australasia" :
											return allBars[0];
										case "North_America" :
											return allBars[1];
										case "Asia" :
											return allBars[2];
										case "Europe" :
											return allBars[3];
										case "SAmerica" :
											return allBars[4];
										default:
											return allBars[0];
									}
								});

								/* Hide the tooltip */
								hideTooltip();
							});

						/* Add the mouseover behaviour to the text to increase the target area */
						text.on("mouseover", function(d, i) {

								var country = d.country;

								var choice = d.choice;
								var x = d3.select(bars[0][i]).attr("x");
								var y = d3.select(bars[0][i]).attr("y");

								d3.select(bars[0][i])
									.attr("fill","#f1c40f");

								makeTooltip(country,choice,x,y);
							})
							.on("mouseout", function(d,i) {

								d3.select(bars[0][i]).attr("fill", function(d, i){
									switch (d.continent) {
										case "Australasia" :
											return allBars[0];
										case "North_America" :
											return allBars[1];
										case "Asia" :
											return allBars[2];
										case "Europe" :
											return allBars[3];
										case "SAmerica" :
											return allBars[4];
										default:
											return allBars[0];
									}
								});

								/* Hide the tooltip */
								hideTooltip();
							});


					}

					function makeTooltip(country,choice,x,y) {

						/*	Create a var to hold the tooltip text string */
						var tooltipText = "";
						var countryString = country.replace(/_/g, ' ');
						var formattedChoice;

						if (field == "TotalPaper") {
							formattedChoice = thousandFormat(choice);
						} else {
							formattedChoice = choice;
						}

						/* Update the tooltip text */
						d3.select(".tooltip")
							.select(".value")
							.html(countryString + "<br /> " + formattedChoice);

						var tooltipWidth = parseInt(($(".tooltip").css("width")), 10);
						var tooltipHeight = parseInt($(".tooltip").css("height"), 10);

						/* Get this bar's x/y values, then augment for the tooltip */
						var xPosition = parseInt(x, 10) - (tooltipWidth/2) + 65;
						var yPosition = parseInt(y, 10) - (tooltipHeight) - 43;

						/* Update the tooltip position and value */
						d3.select(".tooltip")
							.style("left", xPosition + "px")
							.style("top", yPosition + "px");

						/* Show the tooltip */
						d3.select(".tooltip")
							.classed("hidden", false)
							.transition()
							.duration(duration/2)
							.style("opacity", 1);

					}

					function hideTooltip() {
						d3.select(".tooltip")
							.transition()
							.duration(duration/2)
							.style("opacity", 0)
							.each("end", function() {
								d3.select(".tooltip").classed("hidden", true);
							});
					}

					function updateHeader (field) {

						switch (field) {
							case "TotalPaper" :
								headerString = "Total papers published";
								axisString = "Papers published";
								break;
							case "SingleF" :
								headerString = "Single female";
								axisString = "Citations";
								break;
							case "SingleM" :
								headerString = "Single male";
								axisString = "Citations";
								break;
							case "NatFirstF" :
								headerString = "National first female";
								axisString = "Citations";
								break;
							case "NatFirstM" :
								headerString = "National first male";
								axisString = "Citations";
								break;
							case "NatLastF" :
								headerString = "National last female";
								axisString = "Citations";
								break;
							case "NatLastM" :
								headerString = "National last male";
								axisString = "Citations";
								break;
							case "IntFirstF" :
								headerString = "International first female";
								axisString = "Citations";
								break;
							case "IntFirstM" :
								headerString = "International first male";
								axisString = "Citations";
								break;
							case "IntLastF" :
								headerString = "International last female";
								axisString = "Citations";
								break;
							case "IntLastM" :
								headerString = "International last male";
								axisString = "Citations";
								break;
							case "FMRatio" :
								headerString = "Female to male ratio";
								axisString = "Female to male ratio";
								break;
						}

						d3.select(".outer-wrapper h1").text(headerString);

						d3.selectAll(".y .axisLabel text")
							.text(axisString);
					}

					/* An inital call of updateDisplayArray()  */
					updateDisplayArray();

					/* Build the custom checkboxes */
					setupLabel();

				}
			}); /* End of ajax a call */


		/* End of active code */
		};

	setTimeout(function()
	{
	if (typeof jQuery !== 'undefined')
	{
		init(jQuery);
	} else
	{
		setTimeout(arguments.callee, 60);
	}
	}, 60);

})();
</script>
<!--<![endif]-->
<!-- ========= PASTED POLOPOLY FOOTER BELOW ========= -->

</div>							
						</div>
					</section>
				</div>
			</article>
		</div>
	</div>
</div>
</div>
</body>
</html>